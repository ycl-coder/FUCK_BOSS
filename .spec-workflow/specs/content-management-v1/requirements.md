# Requirements Document

## Introduction

本文档定义了全国公司曝光平台第一版本（v1）的功能需求。第一版本聚焦核心功能：匿名发布、内容查看和搜索。该版本旨在快速上线，验证产品价值，为后续版本奠定基础。

**功能范围**：
- 用户可匿名发布公司不当行为
- 用户可按城市浏览曝光内容
- 用户可搜索特定公司或关键词

**技术架构**：采用 DDD 分层架构，后端使用 Go + gRPC，前端使用 React，数据存储使用 PostgreSQL 和 Redis。

## Alignment with Product Vision

本功能规范完全符合产品指导文档（product.md）中定义的第一版本目标：

1. **匿名保护**：实现完全匿名的发布机制，不收集任何可追踪信息
2. **城市分类**：支持按城市组织内容，便于本地化查找
3. **信息透明**：提供清晰的查看和搜索功能，帮助用户快速找到相关信息
4. **简单易用**：界面简洁，操作流程简单，降低使用门槛

## Requirements

### Requirement 1: 匿名发布曝光内容

**User Story:** 作为一个想要曝光公司不当行为的用户，我希望能够匿名发布曝光内容，以便在保护自己身份安全的前提下分享信息。

#### Acceptance Criteria

1. **WHEN** 用户访问发布页面 **THEN** 系统 **SHALL** 显示发布表单，包含以下字段：
   - 公司名称（必填，文本输入，最大长度 100 字符）
   - 城市（必填，下拉选择，支持主要城市列表）
   - 问题描述（必填，多行文本，最大长度 5000 字符）
   - 发生时间（可选，日期选择器）

2. **WHEN** 用户提交表单 **AND** 所有必填字段已填写 **AND** 字段长度符合要求 **THEN** 系统 **SHALL**：
   - 保存内容到数据库
   - 返回成功提示
   - 不记录任何可追踪信息（IP、设备信息等）

3. **IF** 用户提交表单 **AND** 必填字段为空 **OR** 字段长度超出限制 **THEN** 系统 **SHALL**：
   - 显示具体验证错误信息
   - 阻止提交
   - 保持表单数据（不丢失用户输入）

4. **WHEN** 内容发布成功 **THEN** 系统 **SHALL**：
   - 自动刷新城市内容列表（如果适用）
   - 显示成功消息
   - 可选：跳转到内容详情页

5. **WHEN** 系统保存内容 **THEN** 系统 **SHALL**：
   - 生成唯一的内容 ID
   - 记录创建时间戳
   - 设置内容状态为"已发布"
   - 不存储任何用户标识信息

#### Business Rules

- 公司名称支持中文、英文、数字和常见符号
- 城市列表包含全国主要城市（至少 50 个）
- 问题描述支持换行和基本格式化
- 同一 IP 在 1 小时内最多发布 3 条内容（防刷机制，使用 Redis 实现）

#### Testing Requirements

- **单元测试**：验证字段验证逻辑、业务规则
- **集成测试**：验证数据库保存、Redis 限流
- **E2E 测试**：完整发布流程，包括成功和失败场景
- **性能测试**：验证限流机制有效性

### Requirement 2: 查看曝光内容列表

**User Story:** 作为一个想要了解公司情况的用户，我希望能够按城市浏览曝光内容列表，以便快速了解目标城市的公司问题。

#### Acceptance Criteria

1. **WHEN** 用户访问首页或城市页面 **THEN** 系统 **SHALL** 显示：
   - 城市选择器（支持切换城市）
   - 内容列表（按时间倒序排列）
   - 分页控件（每页 20 条）

2. **WHEN** 用户选择不同城市 **THEN** 系统 **SHALL**：
   - 刷新列表，显示该城市的内容
   - 更新 URL（支持直接访问特定城市）
   - 显示城市名称和内容数量

3. **WHEN** 系统加载内容列表 **THEN** 系统 **SHALL** 显示每条内容的：
   - 公司名称（可点击，跳转到详情）
   - 城市名称
   - 问题描述摘要（前 200 字符，超出显示省略号）
   - 发布时间（相对时间，如"2 小时前"）
   - 内容 ID（用于详情页跳转）

4. **IF** 当前城市没有内容 **THEN** 系统 **SHALL** 显示空状态提示："该城市暂无曝光内容"

5. **WHEN** 用户点击"加载更多"或翻页 **THEN** 系统 **SHALL**：
   - 加载下一页内容
   - 保持滚动位置或跳转到列表顶部
   - 显示加载状态

6. **WHEN** 系统加载列表 **THEN** 系统 **SHALL**：
   - 优先从 Redis 缓存读取（缓存 5 分钟）
   - 缓存未命中时从 PostgreSQL 查询
   - 更新缓存

#### Business Rules

- 列表按创建时间倒序排列（最新在前）
- 每页显示 20 条内容
- 支持无限滚动或分页（前端实现选择）
- 缓存策略：热门城市缓存 5 分钟，其他城市缓存 10 分钟

#### Performance Requirements

- 列表加载时间 < 200ms（有缓存）
- 列表加载时间 < 500ms（无缓存，数据库查询）
- 支持并发 100+ 用户同时浏览

#### Testing Requirements

- **单元测试**：验证列表排序、分页逻辑
- **集成测试**：验证数据库查询、Redis 缓存
- **E2E 测试**：完整浏览流程，包括城市切换、分页
- **性能测试**：验证缓存效果、并发性能

### Requirement 3: 查看内容详情

**User Story:** 作为一个想要了解具体公司问题的用户，我希望能够查看曝光内容的完整详情，以便获得更详细的信息。

#### Acceptance Criteria

1. **WHEN** 用户点击列表中的内容 **THEN** 系统 **SHALL** 跳转到详情页，显示：
   - 完整的问题描述
   - 公司名称
   - 城市名称
   - 发布时间（完整时间戳）
   - 内容 ID

2. **WHEN** 用户通过直接 URL 访问详情页 **AND** 内容存在 **THEN** 系统 **SHALL** 正常显示内容详情

3. **IF** 用户访问不存在的内容 ID **THEN** 系统 **SHALL** 显示 404 错误页面

4. **WHEN** 系统加载详情 **THEN** 系统 **SHALL**：
   - 优先从 Redis 缓存读取（缓存 10 分钟）
   - 缓存未命中时从 PostgreSQL 查询
   - 更新缓存

5. **WHEN** 用户查看详情 **THEN** 系统 **SHALL** 提供：
   - 返回列表的链接/按钮
   - 分享功能（未来版本，第一版本可预留接口）

#### Business Rules

- 详情页不显示任何发布者信息
- 内容一旦发布，不可编辑或删除（第一版本）
- 支持直接 URL 访问（SEO 友好）

#### Testing Requirements

- **单元测试**：验证详情查询逻辑
- **集成测试**：验证数据库查询、缓存
- **E2E 测试**：从列表跳转到详情，直接 URL 访问

### Requirement 4: 搜索曝光内容

**User Story:** 作为一个想要查找特定公司信息的用户，我希望能够通过公司名称或关键词搜索曝光内容，以便快速找到相关信息。

#### Acceptance Criteria

1. **WHEN** 用户访问搜索页面或在首页看到搜索框 **THEN** 系统 **SHALL** 显示：
   - 搜索输入框
   - 搜索按钮或自动搜索（输入后自动触发）
   - 可选：城市筛选器

2. **WHEN** 用户输入搜索关键词（公司名称或问题描述中的关键词）**THEN** 系统 **SHALL**：
   - 实时显示搜索结果（可选，或点击搜索后显示）
   - 高亮显示匹配的关键词
   - 显示匹配的内容列表（格式与列表页相同）

3. **WHEN** 用户同时选择城市筛选 **THEN** 系统 **SHALL** 只显示该城市内的搜索结果

4. **IF** 搜索无结果 **THEN** 系统 **SHALL** 显示："未找到相关内容，请尝试其他关键词"

5. **WHEN** 系统执行搜索 **THEN** 系统 **SHALL**：
   - 使用 PostgreSQL 全文搜索功能
   - 搜索范围：公司名称、问题描述
   - 支持中文分词搜索
   - 结果按相关性排序（匹配度高的在前）

6. **WHEN** 搜索关键词为空 **THEN** 系统 **SHALL** 显示提示："请输入搜索关键词"

#### Business Rules

- 搜索关键词最小长度：2 个字符
- 搜索不区分大小写
- 支持部分匹配（模糊搜索）
- 搜索结果最多返回 100 条
- 搜索关键词长度限制：50 字符

#### Performance Requirements

- 搜索响应时间 < 500ms（有缓存）
- 搜索响应时间 < 1000ms（无缓存，数据库查询）
- 支持并发搜索请求

#### Testing Requirements

- **单元测试**：验证搜索逻辑、关键词处理
- **集成测试**：验证 PostgreSQL 全文搜索、缓存
- **E2E 测试**：完整搜索流程，包括各种搜索场景
- **性能测试**：验证搜索性能、并发搜索

### Requirement 5: 城市管理

**User Story:** 作为系统，我需要维护城市列表，以便用户能够选择城市进行分类和筛选。

#### Acceptance Criteria

1. **WHEN** 系统初始化 **THEN** 系统 **SHALL** 加载预定义的城市列表（至少 50 个主要城市）

2. **WHEN** 用户需要选择城市 **THEN** 系统 **SHALL** 提供城市列表，包含：
   - 城市名称（中文）
   - 城市代码（可选，用于 URL 友好）

3. **WHEN** 系统加载城市列表 **THEN** 系统 **SHALL**：
   - 从 Redis 缓存读取（缓存 24 小时）
   - 缓存未命中时从 PostgreSQL 查询
   - 城市列表存储在数据库的配置表中

#### Business Rules

- 城市列表支持按拼音排序
- 支持热门城市置顶（可选）
- 城市数据通过数据库迁移脚本初始化

#### Testing Requirements

- **单元测试**：验证城市列表加载逻辑
- **集成测试**：验证缓存、数据库查询

## Non-Functional Requirements

### Code Architecture and Modularity

遵循 DDD 分层架构原则：

- **Single Responsibility Principle**: 每个文件、函数只负责一个明确的功能
  - Domain Layer: 实体、值对象、Repository 接口
  - Application Layer: Use Cases（一个用例一个文件）
  - Infrastructure Layer: Repository 实现、缓存实现
  - Presentation Layer: gRPC Handlers

- **Modular Design**: 组件、服务相互独立，可复用
  - 领域模块：Content Domain、Search Domain
  - 基础设施模块：PostgreSQL Repository、Redis Cache
  - 共享模块：错误处理、验证工具

- **Dependency Management**: 最小化模块间依赖
  - Domain Layer 不依赖任何其他层
  - Application Layer 只依赖 Domain Layer
  - Infrastructure Layer 实现 Domain Layer 定义的接口
  - 使用依赖注入（Wire）管理依赖

- **Clear Interfaces**: 定义清晰的组件契约
  - Repository 接口定义在 Domain Layer
  - Use Case 接口定义在 Application Layer
  - 所有接口必须有明确的文档注释

### Performance

- **API 响应时间**：
  - 列表查询（有缓存）：< 200ms
  - 列表查询（无缓存）：< 500ms
  - 详情查询（有缓存）：< 100ms
  - 详情查询（无缓存）：< 300ms
  - 搜索（有缓存）：< 500ms
  - 搜索（无缓存）：< 1000ms
  - 发布操作：< 500ms

- **并发支持**：
  - 支持 1000+ 并发请求
  - 数据库连接池：最大 100 连接
  - Redis 连接池：最大 50 连接

- **缓存策略**：
  - 列表缓存：5-10 分钟（根据城市热度）
  - 详情缓存：10 分钟
  - 城市列表缓存：24 小时
  - 搜索结果缓存：5 分钟

### Security

- **匿名保护**：
  - 不记录用户 IP 地址（或加密存储）
  - 不存储任何设备指纹信息
  - 不要求用户注册或登录

- **数据验证**：
  - 所有输入必须验证
  - 防止 SQL 注入（使用参数化查询）
  - 防止 XSS 攻击（前端转义输出）

- **限流保护**：
  - 发布接口：同一 IP 1 小时内最多 3 次
  - 搜索接口：同一 IP 1 分钟内最多 30 次
  - 使用 Redis 实现限流

- **内容安全**：
  - 输入内容长度限制
  - 敏感词过滤（基础版本，未来增强）

### Reliability

- **可用性目标**：99.9%（月度）
- **错误处理**：
  - 所有错误必须有明确的错误信息
  - 系统错误不暴露内部细节给用户
  - 记录详细的错误日志（使用结构化日志）

- **数据一致性**：
  - 使用数据库事务保证数据一致性
  - 缓存失效策略：写入时更新缓存

- **容错机制**：
  - Redis 故障时降级到直接查询数据库
  - 数据库连接失败时返回友好错误提示

### Usability

- **界面简洁**：
  - 首页清晰展示核心功能入口
  - 发布表单简单直观，字段说明清晰
  - 列表和详情页信息层次分明

- **响应式设计**：
  - 支持桌面端和移动端访问
  - 移动端优化触摸操作

- **错误提示**：
  - 表单验证错误实时提示
  - 网络错误友好提示
  - 加载状态清晰显示

- **性能体验**：
  - 列表和详情页支持骨架屏加载
  - 搜索支持防抖，避免频繁请求

## Testing & Verification Requirements

### 测试策略

每个功能开发完成后，必须完成以下测试验证：

1. **单元测试**（必须）
   - Domain Layer: 实体、值对象、领域服务测试
   - Application Layer: Use Case 测试（Mock Repository）
   - Infrastructure Layer: Repository 实现测试（Mock 数据库）

2. **集成测试**（必须）
   - Repository 与 PostgreSQL 集成测试
   - Cache 与 Redis 集成测试
   - 使用 Docker Compose 启动测试环境
   - 每个测试用例使用独立事务，测试后回滚

3. **端到端测试**（必须）
   - 完整用户流程测试（发布 → 查看 → 搜索）
   - gRPC 服务端到端测试
   - 前端 E2E 测试（可选，但推荐）

### 三方组件验证流程

**重要原则**：设计三方组件时，必须保证调通后再进入下一步。

#### 验证步骤

1. **组件设计阶段**
   - 定义接口和依赖
   - 编写接口测试用例

2. **实现阶段**
   - 实现组件功能
   - 编写单元测试

3. **集成验证阶段** ⚠️ **必须完成此步骤**
   - 启动真实依赖（PostgreSQL、Redis）
   - 编写集成测试，验证组件与依赖的交互
   - **确保所有测试通过**
   - 验证错误处理和边界情况
   - 验证性能指标（响应时间、并发）

4. **文档更新**
   - 更新组件使用文档
   - 记录已知问题和限制

5. **进入下一步**
   - 只有集成验证通过后，才能继续开发依赖该组件的功能

#### 示例验证清单

**PostgreSQL Repository 组件**：
- [ ] 单元测试通过（Mock 数据库）
- [ ] 集成测试通过（真实 PostgreSQL）
- [ ] 验证 CRUD 操作
- [ ] 验证事务处理
- [ ] 验证错误处理
- [ ] 验证性能（查询时间 < 500ms）
- [ ] 文档已更新

**Redis Cache 组件**：
- [ ] 单元测试通过（Mock Redis）
- [ ] 集成测试通过（真实 Redis）
- [ ] 验证 Get/Set 操作
- [ ] 验证 TTL 设置
- [ ] 验证错误处理（Redis 故障降级）
- [ ] 验证性能（操作时间 < 10ms）
- [ ] 文档已更新

### 测试覆盖率要求

- **Domain Layer**: >= 90%
- **Application Layer**: >= 80%
- **Infrastructure Layer**: >= 70%
- **整体覆盖率**: >= 75%

### 持续集成

- 所有测试必须在 CI 中自动运行
- 测试失败阻止代码合并
- 使用 Docker Compose 提供测试环境（PostgreSQL + Redis）

## Out of Scope (第一版本不包含)

以下功能不在第一版本范围内，但为未来版本预留接口：

1. **用户认证系统**：第一版本完全匿名，无需登录
2. **内容审核**：第一版本人工审核（后台管理，不在本规范内）
3. **用户互动**：点赞、评论、举报功能
4. **内容编辑/删除**：发布后不可修改
5. **高级搜索**：多条件组合搜索、筛选
6. **内容分类**：按问题类型分类（薪资、加班等）
7. **数据统计**：城市/公司统计图表
8. **移动端 App**：第一版本仅 Web 端

## Success Criteria

第一版本成功标准：

1. **功能完整性**：所有核心功能（发布、查看、搜索）正常运行
2. **性能达标**：所有 API 响应时间符合性能要求
3. **测试覆盖**：测试覆盖率 >= 75%，所有集成测试通过
4. **文档完整**：API 文档、开发文档、部署文档齐全
5. **可用性**：系统可用性 >= 99.9%，无严重 Bug

