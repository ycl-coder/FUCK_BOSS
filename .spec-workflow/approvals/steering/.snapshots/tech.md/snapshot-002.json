{
  "id": "snapshot_1767670308857_n4o4q1h5w",
  "approvalId": "approval_1767670156534_7z9dio7kh",
  "approvalTitle": "技术栈文档 (tech.md) - DDD架构、PostgreSQL、Redis",
  "version": 2,
  "timestamp": "2026-01-06T03:31:48.857Z",
  "trigger": "revision_requested",
  "status": "pending",
  "content": "# Technology Stack\n\n## Project Type\n\n全国公司曝光平台是一个基于 gRPC 的 Web 应用，采用前后端分离架构。后端使用 Go 语言提供 gRPC 服务，前端使用 React 构建用户界面。\n\n## Core Technologies\n\n### Primary Language(s)\n\n- **后端语言**: Go 1.21+\n- **前端语言**: TypeScript 5.0+ (React)\n- **协议定义**: Protocol Buffers (protobuf)\n- **包管理**: \n  - Go: `go mod`\n  - Frontend: `npm` / `yarn` / `pnpm`\n\n### Key Dependencies/Libraries\n\n#### 后端 (Go)\n- **gRPC-Go**: `google.golang.org/grpc` - gRPC 框架核心\n- **Protocol Buffers**: `google.golang.org/protobuf` - 数据序列化\n- **PostgreSQL 驱动**: `github.com/lib/pq` 或 `gorm.io/gorm` - 数据库访问\n- **Redis 客户端**: `github.com/redis/go-redis/v9` - 缓存和会话管理\n- **依赖注入**: `github.com/google/wire` 或 `github.com/uber-go/fx` - DDD 依赖管理\n- **配置管理**: `github.com/spf13/viper` - 配置读取\n- **日志**: `go.uber.org/zap` - 结构化日志\n- **验证**: `github.com/go-playground/validator/v10` - 数据验证\n- **HTTP 网关**: `github.com/grpc-ecosystem/grpc-gateway/v2` - gRPC 转 HTTP/REST（可选）\n\n#### 前端 (React)\n- **React**: `^18.2.0` - UI 框架\n- **TypeScript**: `^5.0.0` - 类型安全\n- **路由**: `react-router-dom` - 前端路由\n- **状态管理**: `zustand` 或 `@reduxjs/toolkit` - 状态管理\n- **HTTP 客户端**: `axios` 或 `@tanstack/react-query` - API 调用\n- **gRPC Web**: `@grpc/grpc-js` + `@grpc-web/protoc-gen-grpc-web` - gRPC Web 客户端\n- **UI 组件库**: `antd` 或 `@mui/material` - 组件库\n- **构建工具**: `vite` 或 `create-react-app` - 构建和开发工具\n\n### Application Architecture\n\n#### 架构模式：领域驱动设计 (DDD)\n\n采用 DDD 分层架构，将业务逻辑与基础设施分离：\n\n```\n┌─────────────────────────────────────┐\n│   Presentation Layer (API/UI)       │\n│   - gRPC Handlers                   │\n│   - HTTP Gateway (可选)             │\n└──────────────┬──────────────────────┘\n               │\n┌──────────────▼──────────────────────┐\n│   Application Layer                  │\n│   - Use Cases / Application Services │\n│   - DTOs / Commands / Queries       │\n└──────────────┬──────────────────────┘\n               │\n┌──────────────▼──────────────────────┐\n│   Domain Layer (核心业务逻辑)        │\n│   - Entities (聚合根)               │\n│   - Value Objects                   │\n│   - Domain Services                 │\n│   - Repository Interfaces            │\n│   - Domain Events                   │\n└──────────────┬──────────────────────┘\n               │\n┌──────────────▼──────────────────────┐\n│   Infrastructure Layer               │\n│   - Repository Implementations       │\n│   - Database (PostgreSQL)           │\n│   - Cache (Redis)                   │\n│   - External Services                │\n└─────────────────────────────────────┘\n```\n\n#### 领域划分（Bounded Contexts）\n\n1. **内容领域 (Content Context)**\n   - 聚合根：`Post` (曝光内容)\n   - 值对象：`City`, `CompanyName`, `Content`\n   - 领域服务：内容发布、内容审核\n\n2. **搜索领域 (Search Context)**\n   - 聚合根：`SearchIndex`\n   - 领域服务：全文搜索、城市筛选\n\n3. **用户领域 (User Context)** (未来版本)\n   - 聚合根：`AnonymousUser`\n   - 领域服务：匿名标识管理\n\n### Data Storage\n\n#### Primary Storage: PostgreSQL\n\n- **版本**: PostgreSQL 14+\n- **用途**: \n  - 持久化存储曝光内容\n  - 存储城市、公司等基础数据\n  - 支持全文搜索（PostgreSQL Full-Text Search）\n- **连接池**: 使用 `pgx` 或 `gorm` 管理连接池\n- **迁移工具**: `golang-migrate/migrate` 或 `gorm` 自动迁移\n\n#### Caching: Redis\n\n- **版本**: Redis 7.0+\n- **用途**:\n  - 缓存热门内容列表\n  - 缓存城市列表、公司列表\n  - 搜索结果的短期缓存\n  - 限流和防刷机制\n  - 会话存储（未来版本）\n- **数据结构**:\n  - `String`: 简单缓存\n  - `Hash`: 对象缓存\n  - `Sorted Set`: 热门内容排行\n  - `Set`: 去重、标签\n\n#### Data Formats\n\n- **API 通信**: Protocol Buffers (protobuf)\n- **配置**: YAML / JSON\n- **日志**: JSON (结构化日志)\n\n### External Integrations\n\n#### APIs\n- **内容审核服务** (未来版本): 第三方内容审核 API\n- **地理位置服务** (可选): IP 定位服务\n\n#### Protocols\n- **gRPC**: 后端服务间通信\n- **gRPC-Web**: 前端与后端通信\n- **HTTP/REST**: 可选，通过 grpc-gateway 提供 RESTful API\n\n#### Authentication\n- **匿名发布**: 无需认证（第一版本）\n- **未来版本**: JWT Token 或 Session 认证\n\n## Development Environment\n\n### Build & Development Tools\n\n#### 后端\n- **Build System**: `go build` / `make`\n- **开发工具**: \n  - `air` - 热重载\n  - `golangci-lint` - 代码检查\n- **API 生成**: `protoc` + `protoc-gen-go` + `protoc-gen-go-grpc`\n- **代码生成**: `wire` (依赖注入代码生成)\n\n#### 前端\n- **Build System**: `vite` 或 `webpack`\n- **开发工具**: \n  - `vite` HMR (热模块替换)\n  - `eslint` - 代码检查\n  - `prettier` - 代码格式化\n\n### Code Quality Tools\n\n#### 后端\n- **Static Analysis**: `golangci-lint` (集成多种 linter)\n- **Formatting**: `gofmt` / `goimports`\n- **Testing Framework**: \n  - `testing` (标准库) - 单元测试\n  - `testify` - 测试断言和 mock\n  - `gomock` - 接口 mock 生成\n- **Coverage**: `go test -cover`\n- **Documentation**: `godoc` / `swagger` (如果提供 REST API)\n\n#### 前端\n- **Static Analysis**: `eslint` + `typescript-eslint`\n- **Formatting**: `prettier`\n- **Testing Framework**:\n  - `vitest` / `jest` - 单元测试\n  - `@testing-library/react` - React 组件测试\n  - `playwright` / `cypress` - E2E 测试\n- **Type Checking**: TypeScript compiler\n\n### Version Control & Collaboration\n\n- **VCS**: Git\n- **Branching Strategy**: Git Flow\n  - `main`: 生产环境\n  - `develop`: 开发分支\n  - `feature/*`: 功能分支\n  - `fix/*`: 修复分支\n- **Code Review Process**: \n  - 所有代码必须经过 Code Review\n  - 至少一人 Approve 才能合并\n  - CI/CD 检查通过后才能合并\n\n## Deployment & Distribution\n\n### Target Platform(s)\n- **后端**: Linux (Docker 容器)\n- **前端**: 静态文件托管 (Nginx / CDN)\n- **数据库**: PostgreSQL (云服务或自托管)\n- **缓存**: Redis (云服务或自托管)\n\n### Distribution Method\n- **容器化**: Docker + Docker Compose (开发环境)\n- **Kubernetes**: 生产环境 (可选)\n- **CI/CD**: GitHub Actions / GitLab CI\n\n### Installation Requirements\n- **开发环境**:\n  - Go 1.21+\n  - Node.js 18+\n  - PostgreSQL 14+\n  - Redis 7.0+\n  - Docker & Docker Compose (推荐)\n\n### Update Mechanism\n- **数据库迁移**: 通过 migration 工具自动执行\n- **服务更新**: 滚动更新 (零停机)\n\n## Technical Requirements & Constraints\n\n### Performance Requirements\n\n- **API 响应时间**: \n  - 列表查询: < 200ms (有缓存)\n  - 详情查询: < 100ms (有缓存)\n  - 发布操作: < 500ms\n- **并发支持**: 支持 1000+ 并发请求\n- **数据库连接池**: 最大 100 连接\n- **Redis 连接池**: 最大 50 连接\n\n### Compatibility Requirements\n\n- **Go 版本**: >= 1.21\n- **PostgreSQL 版本**: >= 14.0\n- **Redis 版本**: >= 7.0\n- **Node.js 版本**: >= 18.0\n- **浏览器支持**: Chrome, Firefox, Safari, Edge (最新 2 个版本)\n\n### Security & Compliance\n\n#### Security Requirements\n- **数据加密**: \n  - 传输层: TLS 1.3\n  - 存储层: 敏感数据加密存储\n- **SQL 注入防护**: 使用参数化查询，禁止拼接 SQL\n- **XSS 防护**: 前端输入输出转义\n- **CSRF 防护**: Token 验证 (未来版本)\n- **限流**: Redis 实现接口限流，防止恶意刷接口\n- **匿名保护**: \n  - 不记录用户 IP (或加密存储)\n  - 不存储任何可追踪信息\n\n#### Compliance Standards\n- **数据隐私**: 遵循 GDPR 原则（最小化数据收集）\n- **内容合规**: 建立内容审核机制，防止违法内容\n\n#### Threat Model\n- **主要威胁**:\n  - 恶意刷接口\n  - 虚假/恶意内容发布\n  - 数据泄露\n  - DDoS 攻击\n- **防护措施**:\n  - 接口限流\n  - 内容审核（人工+自动）\n  - 数据加密\n  - CDN + WAF\n\n### Scalability & Reliability\n\n#### Expected Load\n- **初期**: 1000 DAU, 10000 条内容\n- **中期**: 10000 DAU, 100000 条内容\n- **长期**: 100000+ DAU, 1000000+ 条内容\n\n#### Availability Requirements\n- **目标可用性**: 99.9% (月度)\n- **故障恢复时间**: < 30 分钟\n- **数据备份**: 每日自动备份，保留 30 天\n\n#### Growth Projections\n- **水平扩展**: \n  - 无状态服务，支持多实例部署\n  - 数据库读写分离（未来）\n  - Redis 集群（未来）\n- **垂直扩展**: \n  - 数据库索引优化\n  - 缓存策略优化\n\n## Technical Decisions & Rationale\n\n### Decision Log\n\n1. **选择 gRPC 而非 REST API**\n   - **原因**: \n     - 类型安全（protobuf）\n     - 性能更好（二进制协议）\n     - 支持流式传输（未来实时功能）\n     - 代码生成，减少手写代码\n   - **权衡**: 需要前端使用 gRPC-Web，增加复杂度\n\n2. **采用 DDD 架构**\n   - **原因**:\n     - 业务逻辑清晰，易于维护\n     - 领域模型与基础设施解耦\n     - 便于测试（依赖注入）\n     - 支持未来功能扩展\n   - **权衡**: 初期开发复杂度较高，但长期收益大\n\n3. **PostgreSQL + Redis 组合**\n   - **原因**:\n     - PostgreSQL: 关系型数据，支持复杂查询和全文搜索\n     - Redis: 高性能缓存，支持复杂数据结构\n     - 两者互补，满足不同场景需求\n   - **权衡**: 需要维护两套存储系统\n\n4. **使用 TypeScript 而非 JavaScript**\n   - **原因**:\n     - 类型安全，减少运行时错误\n     - 更好的 IDE 支持\n     - 代码可读性更好\n   - **权衡**: 需要编译步骤，但收益远大于成本\n\n5. **前端使用 React + 现代构建工具**\n   - **原因**:\n     - React 生态成熟，组件库丰富\n     - Vite 构建速度快，开发体验好\n     - 支持 SSR（未来版本）\n   - **权衡**: 学习曲线，但团队熟悉度高\n\n## Testing & Verification Strategy\n\n### 测试金字塔\n\n```\n        /\\\n       /E2E\\         少量端到端测试\n      /────\\\n     /Integration\\  集成测试（数据库、Redis）\n    /────────────\\\n   /   Unit Test   \\ 大量单元测试\n  /────────────────\\\n```\n\n### 测试要求\n\n#### 1. 单元测试\n- **覆盖率要求**: >= 70% (核心业务逻辑 >= 90%)\n- **测试范围**:\n  - Domain Layer: 所有实体、值对象、领域服务\n  - Application Layer: 所有 Use Cases\n  - Infrastructure Layer: Repository 实现\n- **Mock 策略**: \n  - 使用 `gomock` 生成接口 mock\n  - 测试时隔离外部依赖（数据库、Redis）\n\n#### 2. 集成测试\n- **测试范围**:\n  - Repository 与数据库集成\n  - Redis 缓存集成\n  - gRPC 服务端集成\n- **测试环境**: \n  - 使用 Docker Compose 启动测试数据库和 Redis\n  - 每个测试用例使用独立的事务，测试后回滚\n\n#### 3. 端到端测试\n- **测试范围**:\n  - 完整的用户流程（发布、查看、搜索）\n  - API 端到端测试\n- **工具**: \n  - 后端: `httptest` + gRPC 测试客户端\n  - 前端: Playwright / Cypress\n\n### 三方组件验证流程\n\n**重要原则**: 设计三方组件时，必须保证调通后再进入下一步。\n\n#### 验证步骤\n\n1. **组件设计阶段**\n   - 定义接口和依赖\n   - 编写接口测试用例\n\n2. **实现阶段**\n   - 实现组件功能\n   - 编写单元测试\n\n3. **集成验证阶段** ⚠️ **必须完成此步骤**\n   - 启动真实依赖（PostgreSQL、Redis）\n   - 编写集成测试，验证组件与依赖的交互\n   - **确保所有测试通过**\n   - 验证错误处理和边界情况\n\n4. **文档更新**\n   - 更新组件使用文档\n   - 记录已知问题和限制\n\n5. **进入下一步**\n   - 只有集成验证通过后，才能继续开发依赖该组件的功能\n\n#### 示例：Redis 缓存组件验证\n\n```go\n// 1. 定义接口\ntype CacheRepository interface {\n    Get(ctx context.Context, key string) (string, error)\n    Set(ctx context.Context, key string, value string, ttl time.Duration) error\n}\n\n// 2. 实现\ntype RedisCache struct {\n    client *redis.Client\n}\n\n// 3. 集成测试（必须通过）\nfunc TestRedisCache_Integration(t *testing.T) {\n    // 启动真实 Redis（Docker）\n    client := setupRedis(t)\n    cache := NewRedisCache(client)\n    \n    // 测试 Get/Set\n    err := cache.Set(ctx, \"test\", \"value\", time.Minute)\n    require.NoError(t, err)\n    \n    val, err := cache.Get(ctx, \"test\")\n    require.NoError(t, err)\n    require.Equal(t, \"value\", val)\n    \n    // 测试 TTL\n    // 测试错误处理\n    // ...\n}\n\n// 4. 只有测试通过后，才能在其他地方使用\n```\n\n### 持续集成\n\n- **CI Pipeline**:\n  1. 代码检查 (lint)\n  2. 单元测试\n  3. 集成测试（需要 Docker）\n  4. 构建\n  5. 部署到测试环境\n\n- **测试环境**: \n  - 使用 Docker Compose 提供 PostgreSQL 和 Redis\n  - 每次 CI 运行都使用干净的环境\n\n## Known Limitations\n\n1. **第一版本不支持用户认证**\n   - **影响**: 无法追踪发布者，无法实现个人中心\n   - **解决方案**: 未来版本引入匿名用户系统\n\n2. **内容审核依赖人工**\n   - **影响**: 审核效率低，可能存在延迟\n   - **解决方案**: 未来引入自动审核 + 人工复核\n\n3. **搜索功能基于 PostgreSQL 全文搜索**\n   - **影响**: 性能和功能有限\n   - **解决方案**: 未来引入 Elasticsearch 或 Meilisearch\n\n4. **单数据库架构**\n   - **影响**: 高并发时可能成为瓶颈\n   - **解决方案**: 未来实现读写分离、分库分表\n\n",
  "fileStats": {
    "size": 14421,
    "lines": 468,
    "lastModified": "2026-01-06T03:29:53.646Z"
  },
  "comments": []
}