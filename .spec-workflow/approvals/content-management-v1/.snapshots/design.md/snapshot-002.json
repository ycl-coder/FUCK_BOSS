{
  "id": "snapshot_1767672034526_3dlahkg7e",
  "approvalId": "approval_1767671954529_ncbz53qf5",
  "approvalTitle": "设计文档 (design.md) - DDD架构设计、组件设计、数据模型",
  "version": 2,
  "timestamp": "2026-01-06T04:00:34.526Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\n本文档详细设计全国公司曝光平台第一版本（v1）的技术实现方案。第一版本实现三个核心功能：匿名发布、内容查看和搜索。采用 DDD 分层架构，后端使用 Go + gRPC，前端使用 React，数据存储使用 PostgreSQL 和 Redis。\n\n**设计原则**：\n- 遵循 DDD 分层架构，业务逻辑与基础设施分离\n- 所有组件必须通过集成测试验证后才能使用\n- 每个任务完成后必须完成测试验证\n- 遵循 Go 代码规范（tech.md）\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n本设计严格遵循技术栈文档（tech.md）中定义的标准：\n\n1. **DDD 分层架构**：\n   - Presentation Layer: gRPC Handlers\n   - Application Layer: Use Cases\n   - Domain Layer: Entities, Value Objects, Repository Interfaces\n   - Infrastructure Layer: PostgreSQL Repository, Redis Cache\n\n2. **Go 代码规范**：\n   - 遵循所有必须（[火箭]）规范\n   - 遵循推荐（[火]）规范\n   - 文件长度不超过 800 行\n   - 函数长度不超过 80 行\n   - 嵌套深度不超过 4 层\n\n3. **测试要求**：\n   - 单元测试覆盖率 >= 70%（核心业务逻辑 >= 90%）\n   - 必须完成集成测试（使用真实 PostgreSQL 和 Redis）\n   - 必须完成 E2E 测试\n\n4. **三方组件验证**：\n   - 所有三方组件（PostgreSQL Repository、Redis Cache）必须调通后再进入下一步\n   - 集成测试通过后才能继续开发\n\n### Project Structure (structure.md)\n\n本设计遵循项目结构文档（structure.md）中定义的组织方式：\n\n1. **目录结构**：\n   - `backend/internal/domain/` - 领域层\n   - `backend/internal/application/` - 应用层\n   - `backend/internal/infrastructure/` - 基础设施层\n   - `backend/internal/presentation/` - 表现层\n\n2. **命名规范**：\n   - Go 文件：`snake_case.go`\n   - 类型：`PascalCase`\n   - 函数：`camelCase`\n   - 常量：`UPPER_SNAKE_CASE`\n\n3. **文档组织**：\n   - 设计文档放在 `docs/design/`\n   - 修复文档放在 `docs/fixes/`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n本项目为全新项目，暂无现有代码可复用。但将创建可复用的基础组件：\n\n1. **错误处理包** (`pkg/errors/`)：\n   - 定义统一的错误类型\n   - 错误码和错误消息映射\n   - 可被所有层使用\n\n2. **验证工具包** (`pkg/validator/`)：\n   - 基于 `github.com/go-playground/validator/v10`\n   - 统一的验证规则\n   - 可被 Application Layer 使用\n\n3. **配置管理** (`internal/infrastructure/config/`)：\n   - 基于 `github.com/spf13/viper`\n   - 统一的配置读取\n   - 可被所有层使用\n\n4. **日志工具** (`internal/infrastructure/logger/`)：\n   - 基于 `go.uber.org/zap`\n   - 结构化日志\n   - 可被所有层使用\n\n### Integration Points\n\n1. **PostgreSQL 集成**：\n   - 使用 `github.com/lib/pq` 或 `gorm.io/gorm`\n   - 通过 Repository 接口隔离\n   - 数据库迁移使用 `golang-migrate/migrate`\n\n2. **Redis 集成**：\n   - 使用 `github.com/redis/go-redis/v9`\n   - 通过 Cache Repository 接口隔离\n   - 支持缓存和限流\n\n3. **gRPC 集成**：\n   - 使用 `google.golang.org/grpc`\n   - Protocol Buffers 定义 API\n   - 代码自动生成\n\n## Architecture\n\n### 整体架构\n\n采用 DDD 分层架构，清晰的职责分离：\n\n```mermaid\ngraph TB\n    subgraph \"Frontend (React)\"\n        UI[React Components]\n        API_Client[gRPC Web Client]\n    end\n    \n    subgraph \"Backend - Presentation Layer\"\n        GRPC[gRPC Handlers]\n        Middleware[Middleware<br/>Logging/Recovery]\n    end\n    \n    subgraph \"Backend - Application Layer\"\n        UC_Create[CreatePost UseCase]\n        UC_List[ListPosts UseCase]\n        UC_Get[GetPost UseCase]\n        UC_Search[SearchPosts UseCase]\n    end\n    \n    subgraph \"Backend - Domain Layer\"\n        Post[Post Entity]\n        City[City ValueObject]\n        Company[CompanyName ValueObject]\n        Repo_Interface[PostRepository Interface]\n    end\n    \n    subgraph \"Backend - Infrastructure Layer\"\n        PG_Repo[PostgreSQL Repository]\n        Redis_Cache[Redis Cache]\n        PG[(PostgreSQL)]\n        Redis[(Redis)]\n    end\n    \n    UI --> API_Client\n    API_Client --> GRPC\n    GRPC --> Middleware\n    Middleware --> UC_Create\n    Middleware --> UC_List\n    Middleware --> UC_Get\n    Middleware --> UC_Search\n    \n    UC_Create --> Post\n    UC_List --> Repo_Interface\n    UC_Get --> Repo_Interface\n    UC_Search --> Repo_Interface\n    \n    Repo_Interface --> PG_Repo\n    Repo_Interface --> Redis_Cache\n    PG_Repo --> PG\n    Redis_Cache --> Redis\n```\n\n### Modular Design Principles\n\n1. **Single File Responsibility**：\n   - 每个文件只负责一个明确的职责\n   - 例如：`create_post.go` 只包含创建帖子的用例逻辑\n\n2. **Component Isolation**：\n   - 领域层完全独立，不依赖任何基础设施\n   - Repository 接口定义在 Domain Layer，实现在 Infrastructure Layer\n\n3. **Service Layer Separation**：\n   - Application Layer 只包含用例逻辑，不包含业务规则\n   - Domain Layer 包含所有业务规则和领域逻辑\n\n4. **Utility Modularity**：\n   - 工具函数放在 `pkg/` 目录，可被所有层使用\n   - 每个工具包职责单一\n\n## Components and Interfaces\n\n### Domain Layer\n\n#### Post Entity (聚合根)\n\n**文件**: `backend/internal/domain/content/entity.go`\n\n**Purpose**: 表示曝光内容的聚合根，包含业务规则和不变性约束\n\n**Interfaces**:\n```go\n// Post 曝光内容聚合根\ntype Post struct {\n    id        PostID\n    company   CompanyName\n    city      City\n    content   Content\n    createdAt time.Time\n}\n\n// NewPost 创建新的 Post（工厂方法）\nfunc NewPost(company CompanyName, city City, content Content) (*Post, error)\n\n// Publish 发布内容（业务方法）\nfunc (p *Post) Publish() error\n\n// ID 获取 Post ID\nfunc (p *Post) ID() PostID\n\n// Company 获取公司名称\nfunc (p *Post) Company() CompanyName\n\n// City 获取城市\nfunc (p *Post) City() City\n\n// Content 获取内容\nfunc (p *Post) Content() Content\n\n// CreatedAt 获取创建时间\nfunc (p *Post) CreatedAt() time.Time\n```\n\n**Dependencies**: \n- `PostID` (值对象)\n- `CompanyName` (值对象)\n- `City` (值对象)\n- `Content` (值对象)\n\n**Business Rules**:\n- 公司名称不能为空，长度 1-100 字符\n- 城市必须是有效城市\n- 内容不能为空，长度 10-5000 字符\n- 创建时间自动设置为当前时间\n\n#### Value Objects\n\n**文件**: `backend/internal/domain/content/value_object.go`\n\n**PostID**:\n```go\n// PostID 帖子唯一标识符\ntype PostID struct {\n    value string // UUID 格式\n}\n\n// NewPostID 创建新的 PostID\nfunc NewPostID(value string) (PostID, error)\n\n// String 返回字符串表示\nfunc (id PostID) String() string\n```\n\n**CompanyName**:\n```go\n// CompanyName 公司名称值对象\ntype CompanyName struct {\n    value string\n}\n\n// NewCompanyName 创建新的 CompanyName\nfunc NewCompanyName(value string) (CompanyName, error)\n\n// String 返回字符串表示\nfunc (cn CompanyName) String() string\n```\n\n**Content**:\n```go\n// Content 内容值对象\ntype Content struct {\n    value string\n}\n\n// NewContent 创建新的 Content\nfunc NewContent(value string) (Content, error)\n\n// String 返回字符串表示\nfunc (c Content) String() string\n\n// Summary 返回摘要（前 200 字符）\nfunc (c Content) Summary() string\n```\n\n**City**:\n```go\n// City 城市值对象\ntype City struct {\n    code string // 城市代码，如 \"beijing\"\n    name string // 城市名称，如 \"北京\"\n}\n\n// NewCity 创建新的 City\nfunc NewCity(code, name string) (City, error)\n\n// Code 返回城市代码\nfunc (c City) Code() string\n\n// Name 返回城市名称\nfunc (c City) Name() string\n```\n\n#### PostRepository Interface\n\n**文件**: `backend/internal/domain/content/repository.go`\n\n**Purpose**: 定义 Post 的持久化接口，遵循依赖倒置原则\n\n**Interfaces**:\n```go\n// PostRepository Post 仓储接口\ntype PostRepository interface {\n    // Save 保存 Post\n    Save(ctx context.Context, post *Post) error\n    \n    // FindByID 根据 ID 查找 Post\n    FindByID(ctx context.Context, id PostID) (*Post, error)\n    \n    // FindByCity 根据城市查找 Post 列表（分页）\n    FindByCity(ctx context.Context, city City, page, pageSize int) ([]*Post, int, error)\n    \n    // Search 搜索 Post（全文搜索）\n    Search(ctx context.Context, keyword string, city *City, page, pageSize int) ([]*Post, int, error)\n}\n```\n\n**Dependencies**: Domain Layer 的 Post Entity\n\n**Reuses**: 无（接口定义，不依赖实现）\n\n### Application Layer\n\n#### CreatePost UseCase\n\n**文件**: `backend/internal/application/content/create_post.go`\n\n**Purpose**: 处理创建曝光内容的用例逻辑\n\n**Interfaces**:\n```go\n// CreatePostCommand 创建 Post 的命令\ntype CreatePostCommand struct {\n    Company   string\n    CityCode  string\n    Content   string\n    OccurredAt *time.Time // 可选\n}\n\n// CreatePostUseCase 创建 Post 用例\ntype CreatePostUseCase struct {\n    repo      domain.PostRepository\n    cacheRepo CacheRepository\n    rateLimiter RateLimiter\n}\n\n// NewCreatePostUseCase 创建用例实例\nfunc NewCreatePostUseCase(repo domain.PostRepository, cacheRepo CacheRepository, rateLimiter RateLimiter) *CreatePostUseCase\n\n// Execute 执行创建命令\nfunc (uc *CreatePostUseCase) Execute(ctx context.Context, cmd CreatePostCommand) (*PostDTO, error)\n```\n\n**Dependencies**:\n- `domain.PostRepository` (接口)\n- `CacheRepository` (接口，用于缓存失效)\n- `RateLimiter` (接口，用于限流)\n\n**Reuses**:\n- Domain Layer 的 Post Entity\n- Domain Layer 的 Value Objects\n\n**Business Logic**:\n1. 验证输入（使用 validator）\n2. 检查限流（使用 RateLimiter）\n3. 创建 Domain Entity\n4. 保存到 Repository\n5. 清除相关缓存\n6. 返回 DTO\n\n#### ListPosts UseCase\n\n**文件**: `backend/internal/application/content/list_posts.go`\n\n**Purpose**: 处理列表查询用例逻辑\n\n**Interfaces**:\n```go\n// ListPostsQuery 列表查询参数\ntype ListPostsQuery struct {\n    CityCode string\n    Page     int\n    PageSize int\n}\n\n// ListPostsUseCase 列表查询用例\ntype ListPostsUseCase struct {\n    repo      domain.PostRepository\n    cacheRepo CacheRepository\n}\n\n// Execute 执行查询\nfunc (uc *ListPostsUseCase) Execute(ctx context.Context, query ListPostsQuery) (*PostsListDTO, error)\n```\n\n**Dependencies**:\n- `domain.PostRepository`\n- `CacheRepository`\n\n**Caching Strategy**:\n- 缓存 Key: `posts:city:{cityCode}:page:{page}`\n- 缓存 TTL: 5 分钟（热门城市）或 10 分钟（其他城市）\n- 缓存未命中时查询数据库，并更新缓存\n\n#### GetPost UseCase\n\n**文件**: `backend/internal/application/content/get_post.go`\n\n**Purpose**: 处理获取单个 Post 详情用例逻辑\n\n**Interfaces**:\n```go\n// GetPostUseCase 获取 Post 用例\ntype GetPostUseCase struct {\n    repo      domain.PostRepository\n    cacheRepo CacheRepository\n}\n\n// Execute 执行查询\nfunc (uc *GetPostUseCase) Execute(ctx context.Context, postID string) (*PostDTO, error)\n```\n\n**Caching Strategy**:\n- 缓存 Key: `post:{postID}`\n- 缓存 TTL: 10 分钟\n\n#### SearchPosts UseCase\n\n**文件**: `backend/internal/application/search/search_posts.go`\n\n**Purpose**: 处理搜索用例逻辑\n\n**Interfaces**:\n```go\n// SearchPostsQuery 搜索查询参数\ntype SearchPostsQuery struct {\n    Keyword  string\n    CityCode *string // 可选\n    Page     int\n    PageSize int\n}\n\n// SearchPostsUseCase 搜索用例\ntype SearchPostsUseCase struct {\n    repo      domain.PostRepository\n    cacheRepo CacheRepository\n}\n\n// Execute 执行搜索\nfunc (uc *SearchPostsUseCase) Execute(ctx context.Context, query SearchPostsQuery) (*PostsListDTO, error)\n```\n\n**Search Strategy**:\n- 使用 PostgreSQL 全文搜索（tsvector/tsquery）\n- 搜索范围：公司名称、内容\n- 支持中文分词（使用 PostgreSQL 中文分词扩展，如 pg_jieba）\n\n### Infrastructure Layer\n\n#### PostgreSQL Repository Implementation\n\n**文件**: `backend/internal/infrastructure/persistence/postgres/post_repository.go`\n\n**Purpose**: 实现 PostRepository 接口，使用 PostgreSQL 存储\n\n**Interfaces**:\n```go\n// PostRepository PostgreSQL 实现\ntype PostRepository struct {\n    db *sql.DB\n}\n\n// NewPostRepository 创建 Repository 实例\nfunc NewPostRepository(db *sql.DB) *PostRepository\n\n// Save 实现 domain.PostRepository.Save\nfunc (r *PostRepository) Save(ctx context.Context, post *domain.Post) error\n\n// FindByID 实现 domain.PostRepository.FindByID\nfunc (r *PostRepository) FindByID(ctx context.Context, id domain.PostID) (*domain.Post, error)\n\n// FindByCity 实现 domain.PostRepository.FindByCity\nfunc (r *PostRepository) FindByCity(ctx context.Context, city domain.City, page, pageSize int) ([]*domain.Post, int, error)\n\n// Search 实现 domain.PostRepository.Search\nfunc (r *PostRepository) Search(ctx context.Context, keyword string, city *domain.City, page, pageSize int) ([]*domain.Post, int, error)\n```\n\n**Dependencies**:\n- `database/sql` (标准库)\n- `github.com/lib/pq` (PostgreSQL 驱动)\n\n**Database Schema**:\n```sql\nCREATE TABLE posts (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    company_name VARCHAR(100) NOT NULL,\n    city_code VARCHAR(50) NOT NULL,\n    city_name VARCHAR(50) NOT NULL,\n    content TEXT NOT NULL,\n    occurred_at TIMESTAMP,\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMP NOT NULL DEFAULT NOW()\n);\n\n-- 索引\nCREATE INDEX idx_posts_city_code ON posts(city_code);\nCREATE INDEX idx_posts_created_at ON posts(created_at DESC);\nCREATE INDEX idx_posts_company_name ON posts(company_name);\n\n-- 全文搜索索引\nCREATE INDEX idx_posts_search ON posts USING GIN(to_tsvector('jiebacfg', company_name || ' ' || content));\n```\n\n**Integration Test Requirements**:\n- 必须使用真实 PostgreSQL 数据库\n- 每个测试用例使用独立事务，测试后回滚\n- 验证所有 CRUD 操作\n- 验证全文搜索功能\n\n#### Redis Cache Implementation\n\n**文件**: `backend/internal/infrastructure/persistence/redis/cache_repository.go`\n\n**Purpose**: 实现缓存和限流功能\n\n**Interfaces**:\n```go\n// CacheRepository 缓存接口\ntype CacheRepository interface {\n    // Get 获取缓存\n    Get(ctx context.Context, key string) (string, error)\n    \n    // Set 设置缓存\n    Set(ctx context.Context, key string, value string, ttl time.Duration) error\n    \n    // Delete 删除缓存\n    Delete(ctx context.Context, key string) error\n    \n    // DeleteByPattern 按模式删除缓存\n    DeleteByPattern(ctx context.Context, pattern string) error\n}\n\n// RateLimiter 限流接口\ntype RateLimiter interface {\n    // Allow 检查是否允许请求\n    Allow(ctx context.Context, key string, limit int, window time.Duration) (bool, error)\n}\n\n// RedisCache Redis 缓存实现\ntype RedisCache struct {\n    client *redis.Client\n}\n\n// RedisRateLimiter Redis 限流实现\ntype RedisRateLimiter struct {\n    client *redis.Client\n}\n```\n\n**Dependencies**:\n- `github.com/redis/go-redis/v9`\n\n**Cache Keys**:\n- 列表缓存: `posts:city:{cityCode}:page:{page}`\n- 详情缓存: `post:{postID}`\n- 搜索缓存: `search:{keyword}:city:{cityCode}:page:{page}`\n- 限流 Key: `rate_limit:post:{ip}:{hour}`\n\n**Integration Test Requirements**:\n- 必须使用真实 Redis\n- 验证 Get/Set/Delete 操作\n- 验证 TTL 设置\n- 验证限流功能\n- 验证错误处理（Redis 故障降级）\n\n### Presentation Layer\n\n#### gRPC Handlers\n\n**文件**: `backend/internal/presentation/grpc/content_handler.go`\n\n**Purpose**: 处理 gRPC 请求，调用 Application Layer 的 Use Cases\n\n**Interfaces**:\n```go\n// ContentService gRPC 服务实现\ntype ContentService struct {\n    createUseCase *application.CreatePostUseCase\n    listUseCase   *application.ListPostsUseCase\n    getUseCase    *application.GetPostUseCase\n    searchUseCase *application.SearchPostsUseCase\n}\n\n// CreatePost 处理创建请求\nfunc (s *ContentService) CreatePost(ctx context.Context, req *pb.CreatePostRequest) (*pb.CreatePostResponse, error)\n\n// ListPosts 处理列表请求\nfunc (s *ContentService) ListPosts(ctx context.Context, req *pb.ListPostsRequest) (*pb.ListPostsResponse, error)\n\n// GetPost 处理详情请求\nfunc (s *ContentService) GetPost(ctx context.Context, req *pb.GetPostRequest) (*pb.GetPostResponse, error)\n\n// SearchPosts 处理搜索请求\nfunc (s *ContentService) SearchPosts(ctx context.Context, req *pb.SearchPostsRequest) (*pb.SearchPostsResponse, error)\n```\n\n**Dependencies**:\n- Application Layer 的 Use Cases\n- Protocol Buffers 生成的代码\n\n#### Middleware\n\n**文件**: `backend/internal/presentation/middleware/logging.go`, `recovery.go`\n\n**Purpose**: 提供日志记录和错误恢复中间件\n\n**Interfaces**:\n```go\n// LoggingInterceptor gRPC 日志中间件\nfunc LoggingInterceptor() grpc.UnaryServerInterceptor\n\n// RecoveryInterceptor gRPC 恢复中间件\nfunc RecoveryInterceptor() grpc.UnaryServerInterceptor\n```\n\n## Data Models\n\n### PostgreSQL Schema\n\n#### posts 表\n\n```sql\nCREATE TABLE posts (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    company_name VARCHAR(100) NOT NULL,\n    city_code VARCHAR(50) NOT NULL,\n    city_name VARCHAR(50) NOT NULL,\n    content TEXT NOT NULL,\n    occurred_at TIMESTAMP,\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMP NOT NULL DEFAULT NOW()\n);\n\n-- 索引\nCREATE INDEX idx_posts_city_code ON posts(city_code);\nCREATE INDEX idx_posts_created_at ON posts(created_at DESC);\nCREATE INDEX idx_posts_company_name ON posts(company_name);\n\n-- 全文搜索索引（需要安装 pg_jieba 扩展）\nCREATE EXTENSION IF NOT EXISTS pg_jieba;\nCREATE INDEX idx_posts_search ON posts USING GIN(\n    to_tsvector('jiebacfg', company_name || ' ' || content)\n);\n```\n\n#### cities 表（配置表）\n\n```sql\nCREATE TABLE cities (\n    code VARCHAR(50) PRIMARY KEY,\n    name VARCHAR(50) NOT NULL,\n    pinyin VARCHAR(100),\n    created_at TIMESTAMP NOT NULL DEFAULT NOW()\n);\n\nCREATE INDEX idx_cities_name ON cities(name);\n```\n\n### Protocol Buffers Schema\n\n#### content.proto\n\n```protobuf\nsyntax = \"proto3\";\n\npackage content.v1;\n\noption go_package = \"fuck_boss/api/proto/content/v1;contentv1\";\n\n// ContentService 内容服务\nservice ContentService {\n  // CreatePost 创建曝光内容\n  rpc CreatePost(CreatePostRequest) returns (CreatePostResponse);\n  \n  // ListPosts 获取内容列表\n  rpc ListPosts(ListPostsRequest) returns (ListPostsResponse);\n  \n  // GetPost 获取内容详情\n  rpc GetPost(GetPostRequest) returns (GetPostResponse);\n  \n  // SearchPosts 搜索内容\n  rpc SearchPosts(SearchPostsRequest) returns (SearchPostsResponse);\n}\n\n// CreatePostRequest 创建请求\nmessage CreatePostRequest {\n  string company = 1;        // 公司名称\n  string city_code = 2;      // 城市代码\n  string content = 3;        // 内容\n  int64 occurred_at = 4;     // 发生时间（Unix 时间戳，可选）\n}\n\n// CreatePostResponse 创建响应\nmessage CreatePostResponse {\n  string post_id = 1;        // 帖子 ID\n  int64 created_at = 2;      // 创建时间\n}\n\n// ListPostsRequest 列表请求\nmessage ListPostsRequest {\n  string city_code = 1;      // 城市代码\n  int32 page = 2;            // 页码（从 1 开始）\n  int32 page_size = 3;       // 每页数量\n}\n\n// ListPostsResponse 列表响应\nmessage ListPostsResponse {\n  repeated Post posts = 1;   // 帖子列表\n  int32 total = 2;           // 总数\n  int32 page = 3;            // 当前页码\n  int32 page_size = 4;       // 每页数量\n}\n\n// GetPostRequest 详情请求\nmessage GetPostRequest {\n  string post_id = 1;        // 帖子 ID\n}\n\n// GetPostResponse 详情响应\nmessage GetPostResponse {\n  Post post = 1;             // 帖子详情\n}\n\n// SearchPostsRequest 搜索请求\nmessage SearchPostsRequest {\n  string keyword = 1;        // 搜索关键词\n  string city_code = 2;      // 城市代码（可选）\n  int32 page = 3;            // 页码\n  int32 page_size = 4;       // 每页数量\n}\n\n// SearchPostsResponse 搜索响应\nmessage SearchPostsResponse {\n  repeated Post posts = 1;   // 帖子列表\n  int32 total = 2;           // 总数\n  int32 page = 3;            // 当前页码\n  int32 page_size = 4;       // 每页数量\n}\n\n// Post 帖子\nmessage Post {\n  string id = 1;             // 帖子 ID\n  string company = 2;        // 公司名称\n  string city_code = 3;      // 城市代码\n  string city_name = 4;      // 城市名称\n  string content = 5;        // 内容\n  int64 occurred_at = 6;     // 发生时间\n  int64 created_at = 7;      // 创建时间\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **验证错误**：\n   - **场景**: 用户输入不符合要求（公司名称为空、内容过短等）\n   - **处理**: 返回详细的验证错误信息\n   - **用户影响**: 显示具体字段的错误提示\n\n2. **限流错误**：\n   - **场景**: 同一 IP 在 1 小时内发布超过 3 次\n   - **处理**: 返回限流错误，包含剩余时间\n   - **用户影响**: 显示\"发布过于频繁，请稍后再试\"\n\n3. **数据库错误**：\n   - **场景**: 数据库连接失败、查询超时等\n   - **处理**: 记录错误日志，返回通用错误信息\n   - **用户影响**: 显示\"服务暂时不可用，请稍后重试\"\n\n4. **缓存错误**：\n   - **场景**: Redis 连接失败\n   - **处理**: 降级到直接查询数据库，记录警告日志\n   - **用户影响**: 无（透明降级，用户无感知）\n\n5. **未找到错误**：\n   - **场景**: 查询不存在的 Post ID\n   - **处理**: 返回 NotFound 错误\n   - **用户影响**: 显示 404 页面或错误提示\n\n### Error Types\n\n**文件**: `backend/pkg/errors/errors.go`\n\n```go\n// ErrorCode 错误码\ntype ErrorCode string\n\nconst (\n    ErrCodeValidation   ErrorCode = \"VALIDATION_ERROR\"\n    ErrCodeNotFound     ErrorCode = \"NOT_FOUND\"\n    ErrCodeRateLimit    ErrorCode = \"RATE_LIMIT_EXCEEDED\"\n    ErrCodeInternal     ErrorCode = \"INTERNAL_ERROR\"\n    ErrCodeDatabase     ErrorCode = \"DATABASE_ERROR\"\n)\n\n// AppError 应用错误\ntype AppError struct {\n    Code    ErrorCode\n    Message string\n    Details map[string]interface{}\n    Cause   error\n}\n\nfunc (e *AppError) Error() string {\n    return e.Message\n}\n```\n\n## Testing Strategy\n\n### Unit Testing\n\n**测试范围**:\n- Domain Layer: 所有 Entity、Value Object、业务方法\n- Application Layer: 所有 Use Case（Mock Repository）\n- Infrastructure Layer: Repository 实现（Mock 数据库）\n\n**测试文件组织**:\n```\nbackend/test/unit/\n├── domain/\n│   └── content/\n│       ├── entity_test.go\n│       └── value_object_test.go\n├── application/\n│   └── content/\n│       ├── create_post_test.go\n│       ├── list_posts_test.go\n│       └── get_post_test.go\n└── infrastructure/\n    └── persistence/\n        └── postgres/\n            └── post_repository_test.go\n```\n\n**示例测试**:\n```go\n// backend/test/unit/domain/content/entity_test.go\nfunc TestPost_NewPost(t *testing.T) {\n    company, _ := domain.NewCompanyName(\"测试公司\")\n    city, _ := domain.NewCity(\"beijing\", \"北京\")\n    content, _ := domain.NewContent(\"这是一条测试内容\")\n    \n    post, err := domain.NewPost(company, city, content)\n    require.NoError(t, err)\n    require.NotNil(t, post)\n    require.NotEmpty(t, post.ID().String())\n}\n```\n\n### Integration Testing\n\n**测试范围**:\n- Repository 与 PostgreSQL 集成\n- Cache 与 Redis 集成\n- 完整的 Use Case 流程（使用真实数据库和缓存）\n\n**测试环境**:\n- 使用 Docker Compose 启动 PostgreSQL 和 Redis\n- 每个测试用例使用独立事务，测试后回滚\n- 测试数据隔离\n\n**测试文件组织**:\n```\nbackend/test/integration/\n├── repository/\n│   └── post_repository_test.go\n├── cache/\n│   └── redis_cache_test.go\n└── usecase/\n    └── create_post_test.go\n```\n\n**示例测试**:\n```go\n// backend/test/integration/repository/post_repository_test.go\nfunc TestPostRepository_Save(t *testing.T) {\n    db := setupTestDB(t)\n    defer db.Close()\n    \n    repo := postgres.NewPostRepository(db)\n    \n    company, _ := domain.NewCompanyName(\"测试公司\")\n    city, _ := domain.NewCity(\"beijing\", \"北京\")\n    content, _ := domain.NewContent(\"这是一条测试内容\")\n    post, _ := domain.NewPost(company, city, content)\n    \n    err := repo.Save(context.Background(), post)\n    require.NoError(t, err)\n    \n    // 验证保存成功\n    found, err := repo.FindByID(context.Background(), post.ID())\n    require.NoError(t, err)\n    require.Equal(t, post.ID(), found.ID())\n}\n```\n\n### End-to-End Testing\n\n**测试范围**:\n- 完整的用户流程（发布 → 查看 → 搜索）\n- gRPC 服务端到端测试\n\n**测试场景**:\n1. 用户发布内容 → 查看列表 → 查看详情\n2. 用户搜索关键词 → 查看结果\n3. 用户发布内容 → 触发限流 → 显示错误\n\n**测试文件组织**:\n```\nbackend/test/e2e/\n└── scenarios/\n    ├── create_and_view_test.go\n    └── search_test.go\n```\n\n## Implementation Verification Checklist\n\n每个组件实现后，必须完成以下验证：\n\n### PostgreSQL Repository\n- [ ] 单元测试通过（Mock 数据库）\n- [ ] 集成测试通过（真实 PostgreSQL）\n- [ ] 验证 Save 操作\n- [ ] 验证 FindByID 操作\n- [ ] 验证 FindByCity 操作（分页）\n- [ ] 验证 Search 操作（全文搜索）\n- [ ] 验证事务处理\n- [ ] 验证错误处理\n- [ ] 验证性能（查询时间 < 500ms）\n- [ ] 文档已更新\n\n### Redis Cache\n- [ ] 单元测试通过（Mock Redis）\n- [ ] 集成测试通过（真实 Redis）\n- [ ] 验证 Get/Set 操作\n- [ ] 验证 Delete 操作\n- [ ] 验证 TTL 设置\n- [ ] 验证限流功能\n- [ ] 验证错误处理（Redis 故障降级）\n- [ ] 验证性能（操作时间 < 10ms）\n- [ ] 文档已更新\n\n### Use Cases\n- [ ] 单元测试通过（Mock Repository）\n- [ ] 集成测试通过（真实 Repository）\n- [ ] 验证业务逻辑\n- [ ] 验证缓存策略\n- [ ] 验证错误处理\n- [ ] 文档已更新\n\n### gRPC Handlers\n- [ ] 单元测试通过（Mock UseCase）\n- [ ] E2E 测试通过（完整流程）\n- [ ] 验证请求验证\n- [ ] 验证错误转换\n- [ ] 验证中间件\n- [ ] 文档已更新\n\n",
  "fileStats": {
    "size": 26220,
    "lines": 980,
    "lastModified": "2026-01-06T03:59:22.492Z"
  },
  "comments": []
}