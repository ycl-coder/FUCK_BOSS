{
  "id": "snapshot_1767671090026_sgbvxq2wg",
  "approvalId": "approval_1767671089993_rd1mveztq",
  "approvalTitle": "功能需求文档 (requirements.md) - 发布、查看、搜索功能",
  "version": 1,
  "timestamp": "2026-01-06T03:44:50.026Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\n本文档定义了全国公司曝光平台第一版本（v1）的功能需求。第一版本聚焦核心功能：匿名发布、内容查看和搜索。该版本旨在快速上线，验证产品价值，为后续版本奠定基础。\n\n**功能范围**：\n- 用户可匿名发布公司不当行为\n- 用户可按城市浏览曝光内容\n- 用户可搜索特定公司或关键词\n\n**技术架构**：采用 DDD 分层架构，后端使用 Go + gRPC，前端使用 React，数据存储使用 PostgreSQL 和 Redis。\n\n## Alignment with Product Vision\n\n本功能规范完全符合产品指导文档（product.md）中定义的第一版本目标：\n\n1. **匿名保护**：实现完全匿名的发布机制，不收集任何可追踪信息\n2. **城市分类**：支持按城市组织内容，便于本地化查找\n3. **信息透明**：提供清晰的查看和搜索功能，帮助用户快速找到相关信息\n4. **简单易用**：界面简洁，操作流程简单，降低使用门槛\n\n## Requirements\n\n### Requirement 1: 匿名发布曝光内容\n\n**User Story:** 作为一个想要曝光公司不当行为的用户，我希望能够匿名发布曝光内容，以便在保护自己身份安全的前提下分享信息。\n\n#### Acceptance Criteria\n\n1. **WHEN** 用户访问发布页面 **THEN** 系统 **SHALL** 显示发布表单，包含以下字段：\n   - 公司名称（必填，文本输入，最大长度 100 字符）\n   - 城市（必填，下拉选择，支持主要城市列表）\n   - 问题描述（必填，多行文本，最大长度 5000 字符）\n   - 发生时间（可选，日期选择器）\n\n2. **WHEN** 用户提交表单 **AND** 所有必填字段已填写 **AND** 字段长度符合要求 **THEN** 系统 **SHALL**：\n   - 保存内容到数据库\n   - 返回成功提示\n   - 不记录任何可追踪信息（IP、设备信息等）\n\n3. **IF** 用户提交表单 **AND** 必填字段为空 **OR** 字段长度超出限制 **THEN** 系统 **SHALL**：\n   - 显示具体验证错误信息\n   - 阻止提交\n   - 保持表单数据（不丢失用户输入）\n\n4. **WHEN** 内容发布成功 **THEN** 系统 **SHALL**：\n   - 自动刷新城市内容列表（如果适用）\n   - 显示成功消息\n   - 可选：跳转到内容详情页\n\n5. **WHEN** 系统保存内容 **THEN** 系统 **SHALL**：\n   - 生成唯一的内容 ID\n   - 记录创建时间戳\n   - 设置内容状态为\"已发布\"\n   - 不存储任何用户标识信息\n\n#### Business Rules\n\n- 公司名称支持中文、英文、数字和常见符号\n- 城市列表包含全国主要城市（至少 50 个）\n- 问题描述支持换行和基本格式化\n- 同一 IP 在 1 小时内最多发布 3 条内容（防刷机制，使用 Redis 实现）\n\n#### Testing Requirements\n\n- **单元测试**：验证字段验证逻辑、业务规则\n- **集成测试**：验证数据库保存、Redis 限流\n- **E2E 测试**：完整发布流程，包括成功和失败场景\n- **性能测试**：验证限流机制有效性\n\n### Requirement 2: 查看曝光内容列表\n\n**User Story:** 作为一个想要了解公司情况的用户，我希望能够按城市浏览曝光内容列表，以便快速了解目标城市的公司问题。\n\n#### Acceptance Criteria\n\n1. **WHEN** 用户访问首页或城市页面 **THEN** 系统 **SHALL** 显示：\n   - 城市选择器（支持切换城市）\n   - 内容列表（按时间倒序排列）\n   - 分页控件（每页 20 条）\n\n2. **WHEN** 用户选择不同城市 **THEN** 系统 **SHALL**：\n   - 刷新列表，显示该城市的内容\n   - 更新 URL（支持直接访问特定城市）\n   - 显示城市名称和内容数量\n\n3. **WHEN** 系统加载内容列表 **THEN** 系统 **SHALL** 显示每条内容的：\n   - 公司名称（可点击，跳转到详情）\n   - 城市名称\n   - 问题描述摘要（前 200 字符，超出显示省略号）\n   - 发布时间（相对时间，如\"2 小时前\"）\n   - 内容 ID（用于详情页跳转）\n\n4. **IF** 当前城市没有内容 **THEN** 系统 **SHALL** 显示空状态提示：\"该城市暂无曝光内容\"\n\n5. **WHEN** 用户点击\"加载更多\"或翻页 **THEN** 系统 **SHALL**：\n   - 加载下一页内容\n   - 保持滚动位置或跳转到列表顶部\n   - 显示加载状态\n\n6. **WHEN** 系统加载列表 **THEN** 系统 **SHALL**：\n   - 优先从 Redis 缓存读取（缓存 5 分钟）\n   - 缓存未命中时从 PostgreSQL 查询\n   - 更新缓存\n\n#### Business Rules\n\n- 列表按创建时间倒序排列（最新在前）\n- 每页显示 20 条内容\n- 支持无限滚动或分页（前端实现选择）\n- 缓存策略：热门城市缓存 5 分钟，其他城市缓存 10 分钟\n\n#### Performance Requirements\n\n- 列表加载时间 < 200ms（有缓存）\n- 列表加载时间 < 500ms（无缓存，数据库查询）\n- 支持并发 100+ 用户同时浏览\n\n#### Testing Requirements\n\n- **单元测试**：验证列表排序、分页逻辑\n- **集成测试**：验证数据库查询、Redis 缓存\n- **E2E 测试**：完整浏览流程，包括城市切换、分页\n- **性能测试**：验证缓存效果、并发性能\n\n### Requirement 3: 查看内容详情\n\n**User Story:** 作为一个想要了解具体公司问题的用户，我希望能够查看曝光内容的完整详情，以便获得更详细的信息。\n\n#### Acceptance Criteria\n\n1. **WHEN** 用户点击列表中的内容 **THEN** 系统 **SHALL** 跳转到详情页，显示：\n   - 完整的问题描述\n   - 公司名称\n   - 城市名称\n   - 发布时间（完整时间戳）\n   - 内容 ID\n\n2. **WHEN** 用户通过直接 URL 访问详情页 **AND** 内容存在 **THEN** 系统 **SHALL** 正常显示内容详情\n\n3. **IF** 用户访问不存在的内容 ID **THEN** 系统 **SHALL** 显示 404 错误页面\n\n4. **WHEN** 系统加载详情 **THEN** 系统 **SHALL**：\n   - 优先从 Redis 缓存读取（缓存 10 分钟）\n   - 缓存未命中时从 PostgreSQL 查询\n   - 更新缓存\n\n5. **WHEN** 用户查看详情 **THEN** 系统 **SHALL** 提供：\n   - 返回列表的链接/按钮\n   - 分享功能（未来版本，第一版本可预留接口）\n\n#### Business Rules\n\n- 详情页不显示任何发布者信息\n- 内容一旦发布，不可编辑或删除（第一版本）\n- 支持直接 URL 访问（SEO 友好）\n\n#### Testing Requirements\n\n- **单元测试**：验证详情查询逻辑\n- **集成测试**：验证数据库查询、缓存\n- **E2E 测试**：从列表跳转到详情，直接 URL 访问\n\n### Requirement 4: 搜索曝光内容\n\n**User Story:** 作为一个想要查找特定公司信息的用户，我希望能够通过公司名称或关键词搜索曝光内容，以便快速找到相关信息。\n\n#### Acceptance Criteria\n\n1. **WHEN** 用户访问搜索页面或在首页看到搜索框 **THEN** 系统 **SHALL** 显示：\n   - 搜索输入框\n   - 搜索按钮或自动搜索（输入后自动触发）\n   - 可选：城市筛选器\n\n2. **WHEN** 用户输入搜索关键词（公司名称或问题描述中的关键词）**THEN** 系统 **SHALL**：\n   - 实时显示搜索结果（可选，或点击搜索后显示）\n   - 高亮显示匹配的关键词\n   - 显示匹配的内容列表（格式与列表页相同）\n\n3. **WHEN** 用户同时选择城市筛选 **THEN** 系统 **SHALL** 只显示该城市内的搜索结果\n\n4. **IF** 搜索无结果 **THEN** 系统 **SHALL** 显示：\"未找到相关内容，请尝试其他关键词\"\n\n5. **WHEN** 系统执行搜索 **THEN** 系统 **SHALL**：\n   - 使用 PostgreSQL 全文搜索功能\n   - 搜索范围：公司名称、问题描述\n   - 支持中文分词搜索\n   - 结果按相关性排序（匹配度高的在前）\n\n6. **WHEN** 搜索关键词为空 **THEN** 系统 **SHALL** 显示提示：\"请输入搜索关键词\"\n\n#### Business Rules\n\n- 搜索关键词最小长度：2 个字符\n- 搜索不区分大小写\n- 支持部分匹配（模糊搜索）\n- 搜索结果最多返回 100 条\n- 搜索关键词长度限制：50 字符\n\n#### Performance Requirements\n\n- 搜索响应时间 < 500ms（有缓存）\n- 搜索响应时间 < 1000ms（无缓存，数据库查询）\n- 支持并发搜索请求\n\n#### Testing Requirements\n\n- **单元测试**：验证搜索逻辑、关键词处理\n- **集成测试**：验证 PostgreSQL 全文搜索、缓存\n- **E2E 测试**：完整搜索流程，包括各种搜索场景\n- **性能测试**：验证搜索性能、并发搜索\n\n### Requirement 5: 城市管理\n\n**User Story:** 作为系统，我需要维护城市列表，以便用户能够选择城市进行分类和筛选。\n\n#### Acceptance Criteria\n\n1. **WHEN** 系统初始化 **THEN** 系统 **SHALL** 加载预定义的城市列表（至少 50 个主要城市）\n\n2. **WHEN** 用户需要选择城市 **THEN** 系统 **SHALL** 提供城市列表，包含：\n   - 城市名称（中文）\n   - 城市代码（可选，用于 URL 友好）\n\n3. **WHEN** 系统加载城市列表 **THEN** 系统 **SHALL**：\n   - 从 Redis 缓存读取（缓存 24 小时）\n   - 缓存未命中时从 PostgreSQL 查询\n   - 城市列表存储在数据库的配置表中\n\n#### Business Rules\n\n- 城市列表支持按拼音排序\n- 支持热门城市置顶（可选）\n- 城市数据通过数据库迁移脚本初始化\n\n#### Testing Requirements\n\n- **单元测试**：验证城市列表加载逻辑\n- **集成测试**：验证缓存、数据库查询\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n遵循 DDD 分层架构原则：\n\n- **Single Responsibility Principle**: 每个文件、函数只负责一个明确的功能\n  - Domain Layer: 实体、值对象、Repository 接口\n  - Application Layer: Use Cases（一个用例一个文件）\n  - Infrastructure Layer: Repository 实现、缓存实现\n  - Presentation Layer: gRPC Handlers\n\n- **Modular Design**: 组件、服务相互独立，可复用\n  - 领域模块：Content Domain、Search Domain\n  - 基础设施模块：PostgreSQL Repository、Redis Cache\n  - 共享模块：错误处理、验证工具\n\n- **Dependency Management**: 最小化模块间依赖\n  - Domain Layer 不依赖任何其他层\n  - Application Layer 只依赖 Domain Layer\n  - Infrastructure Layer 实现 Domain Layer 定义的接口\n  - 使用依赖注入（Wire）管理依赖\n\n- **Clear Interfaces**: 定义清晰的组件契约\n  - Repository 接口定义在 Domain Layer\n  - Use Case 接口定义在 Application Layer\n  - 所有接口必须有明确的文档注释\n\n### Performance\n\n- **API 响应时间**：\n  - 列表查询（有缓存）：< 200ms\n  - 列表查询（无缓存）：< 500ms\n  - 详情查询（有缓存）：< 100ms\n  - 详情查询（无缓存）：< 300ms\n  - 搜索（有缓存）：< 500ms\n  - 搜索（无缓存）：< 1000ms\n  - 发布操作：< 500ms\n\n- **并发支持**：\n  - 支持 1000+ 并发请求\n  - 数据库连接池：最大 100 连接\n  - Redis 连接池：最大 50 连接\n\n- **缓存策略**：\n  - 列表缓存：5-10 分钟（根据城市热度）\n  - 详情缓存：10 分钟\n  - 城市列表缓存：24 小时\n  - 搜索结果缓存：5 分钟\n\n### Security\n\n- **匿名保护**：\n  - 不记录用户 IP 地址（或加密存储）\n  - 不存储任何设备指纹信息\n  - 不要求用户注册或登录\n\n- **数据验证**：\n  - 所有输入必须验证\n  - 防止 SQL 注入（使用参数化查询）\n  - 防止 XSS 攻击（前端转义输出）\n\n- **限流保护**：\n  - 发布接口：同一 IP 1 小时内最多 3 次\n  - 搜索接口：同一 IP 1 分钟内最多 30 次\n  - 使用 Redis 实现限流\n\n- **内容安全**：\n  - 输入内容长度限制\n  - 敏感词过滤（基础版本，未来增强）\n\n### Reliability\n\n- **可用性目标**：99.9%（月度）\n- **错误处理**：\n  - 所有错误必须有明确的错误信息\n  - 系统错误不暴露内部细节给用户\n  - 记录详细的错误日志（使用结构化日志）\n\n- **数据一致性**：\n  - 使用数据库事务保证数据一致性\n  - 缓存失效策略：写入时更新缓存\n\n- **容错机制**：\n  - Redis 故障时降级到直接查询数据库\n  - 数据库连接失败时返回友好错误提示\n\n### Usability\n\n- **界面简洁**：\n  - 首页清晰展示核心功能入口\n  - 发布表单简单直观，字段说明清晰\n  - 列表和详情页信息层次分明\n\n- **响应式设计**：\n  - 支持桌面端和移动端访问\n  - 移动端优化触摸操作\n\n- **错误提示**：\n  - 表单验证错误实时提示\n  - 网络错误友好提示\n  - 加载状态清晰显示\n\n- **性能体验**：\n  - 列表和详情页支持骨架屏加载\n  - 搜索支持防抖，避免频繁请求\n\n## Testing & Verification Requirements\n\n### 测试策略\n\n每个功能开发完成后，必须完成以下测试验证：\n\n1. **单元测试**（必须）\n   - Domain Layer: 实体、值对象、领域服务测试\n   - Application Layer: Use Case 测试（Mock Repository）\n   - Infrastructure Layer: Repository 实现测试（Mock 数据库）\n\n2. **集成测试**（必须）\n   - Repository 与 PostgreSQL 集成测试\n   - Cache 与 Redis 集成测试\n   - 使用 Docker Compose 启动测试环境\n   - 每个测试用例使用独立事务，测试后回滚\n\n3. **端到端测试**（必须）\n   - 完整用户流程测试（发布 → 查看 → 搜索）\n   - gRPC 服务端到端测试\n   - 前端 E2E 测试（可选，但推荐）\n\n### 三方组件验证流程\n\n**重要原则**：设计三方组件时，必须保证调通后再进入下一步。\n\n#### 验证步骤\n\n1. **组件设计阶段**\n   - 定义接口和依赖\n   - 编写接口测试用例\n\n2. **实现阶段**\n   - 实现组件功能\n   - 编写单元测试\n\n3. **集成验证阶段** ⚠️ **必须完成此步骤**\n   - 启动真实依赖（PostgreSQL、Redis）\n   - 编写集成测试，验证组件与依赖的交互\n   - **确保所有测试通过**\n   - 验证错误处理和边界情况\n   - 验证性能指标（响应时间、并发）\n\n4. **文档更新**\n   - 更新组件使用文档\n   - 记录已知问题和限制\n\n5. **进入下一步**\n   - 只有集成验证通过后，才能继续开发依赖该组件的功能\n\n#### 示例验证清单\n\n**PostgreSQL Repository 组件**：\n- [ ] 单元测试通过（Mock 数据库）\n- [ ] 集成测试通过（真实 PostgreSQL）\n- [ ] 验证 CRUD 操作\n- [ ] 验证事务处理\n- [ ] 验证错误处理\n- [ ] 验证性能（查询时间 < 500ms）\n- [ ] 文档已更新\n\n**Redis Cache 组件**：\n- [ ] 单元测试通过（Mock Redis）\n- [ ] 集成测试通过（真实 Redis）\n- [ ] 验证 Get/Set 操作\n- [ ] 验证 TTL 设置\n- [ ] 验证错误处理（Redis 故障降级）\n- [ ] 验证性能（操作时间 < 10ms）\n- [ ] 文档已更新\n\n### 测试覆盖率要求\n\n- **Domain Layer**: >= 90%\n- **Application Layer**: >= 80%\n- **Infrastructure Layer**: >= 70%\n- **整体覆盖率**: >= 75%\n\n### 持续集成\n\n- 所有测试必须在 CI 中自动运行\n- 测试失败阻止代码合并\n- 使用 Docker Compose 提供测试环境（PostgreSQL + Redis）\n\n## Out of Scope (第一版本不包含)\n\n以下功能不在第一版本范围内，但为未来版本预留接口：\n\n1. **用户认证系统**：第一版本完全匿名，无需登录\n2. **内容审核**：第一版本人工审核（后台管理，不在本规范内）\n3. **用户互动**：点赞、评论、举报功能\n4. **内容编辑/删除**：发布后不可修改\n5. **高级搜索**：多条件组合搜索、筛选\n6. **内容分类**：按问题类型分类（薪资、加班等）\n7. **数据统计**：城市/公司统计图表\n8. **移动端 App**：第一版本仅 Web 端\n\n## Success Criteria\n\n第一版本成功标准：\n\n1. **功能完整性**：所有核心功能（发布、查看、搜索）正常运行\n2. **性能达标**：所有 API 响应时间符合性能要求\n3. **测试覆盖**：测试覆盖率 >= 75%，所有集成测试通过\n4. **文档完整**：API 文档、开发文档、部署文档齐全\n5. **可用性**：系统可用性 >= 99.9%，无严重 Bug\n\n",
  "fileStats": {
    "size": 16049,
    "lines": 455,
    "lastModified": "2026-01-06T03:35:38.154Z"
  },
  "comments": []
}